<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/vlasiator_manual/libs/highlight/github.min.css"> <link rel=stylesheet  href="/vlasiator_manual/css/jtd.css"> <link rel=icon  href="/vlasiator_manual/assets/favicon.ico"> <title>Trouble Shooting</title> <div class=page-wrap > <div class=side-bar > <div class=header > <a href="/vlasiator_manual/" class=title > Vlasiator </a> </div> <label for=show-menu  class=show-menu >MENU</label> <input type=checkbox  id=show-menu  role=button > <div class=menu  id=side-menu > <ul class=menu-list > <li class="menu-list-item "><a href="/vlasiator_manual/" class="menu-list-link ">Home</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/" class="menu-list-link ">Installation</a> <ul class="menu-list-child-list "> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#dccrg" class=menu-list-link >DCCRG</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#zoltan" class=menu-list-link >Zoltan</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#boost" class=menu-list-link >Boost</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#eigen" class=menu-list-link >Eigen</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#jemalloc" class=menu-list-link >Jemalloc</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#phiprof" class=menu-list-link >PhiProf</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#papi" class=menu-list-link >Papi</a> </ul> <li class="menu-list-item "><a href="/vlasiator_manual/menu2/" class="menu-list-link ">Run</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu3/" class="menu-list-link ">Postprocessing</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu4/" class="menu-list-link ">Internal</a> <ul class="menu-list-child-list "> <li class="menu-list-item "><a href="/vlasiator_manual/menu4/#sysboundary" class=menu-list-link >SysBoundary</a> </ul> <li class="menu-list-item "><a href="/vlasiator_manual/menu5/" class="menu-list-link ">Test</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu6/" class="menu-list-link ">Misc</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu7/" class="menu-list-link ">Method</a> <li class="menu-list-item active"><a href="/vlasiator_manual/menu8/" class="menu-list-link active">Trouble Shooting</a> </ul> </div> <div class=footer > This is <em>Just the docs</em>, adapted from the <a href="https://github.com/pmarsceill/just-the-docs" target=_blank >Jekyll theme</a>. </div> </div> <div class=main-content-wrap > <div class=main-content > <div class=main-header > <a id=github  href="/vlasiator_manual//github.com/fmihpc/vlasiator">Vlasiator on GitHub</a> </div> <div class=franklin-content ><h1 id=trouble_shooting ><a href="#trouble_shooting" class=header-anchor >Trouble Shooting</a></h1> <div class=franklin-toc ><ol><li><a href="#memory">Memory</a><li><a href="#performance">Performance</a></ol></div> <h2 id=memory ><a href="#memory" class=header-anchor >Memory</a></h2> <p>Memory is often the bottleneck for Vlasiator. Vlasiator is not constant in memory usage: as the plasma system evolves from initial state, which is mostly described by a Maxwellian distribution, the system shifts away from thermal equilibrium states and the blocks it requires to resolve the nonMaxwellian distribution may drastically increase. The total block counts can easily increase 5x as the system evolves into a quasi-steady state.</p> <p>All kinds of weird error messages may pop up due to runtime out-of-memory error:</p> <ul> <li><p><code>Segmentation fault</code></p> <li><p><code>Out-of-memory</code></p> <li><p><code>malloc failed</code></p> </ul> <p>Even if you set the maximum memory limit for bailing-out when compiled with PAPI in configuration files, it may still crash because of memory fragmentations. Check <code>memoryallocation.cpp</code> in the source code if you want to see the details.</p> <h2 id=performance ><a href="#performance" class=header-anchor >Performance</a></h2> <p>Vlasiator is distributed with MPI&#43;OpenMP, but the optimal MPI tasks &#43; OpenMP threads combination differs case by case. Hyperthreading may or may not help.</p> <p>On many clusters with Slurm job scheduler, hyperthreading is on by adding</p> <pre><code class="shell hljs"><span class=hljs-meta >#</span><span class=language-bash >SBATCH --hint=multithread</span></code></pre>
<p>A general MPI &#43; OpenMP with simultaneous multithreading example Slurm script:</p>
<pre><code class="shell hljs"><span class=hljs-meta >#</span><span class=language-bash >!/bin/bash</span>
<span class=hljs-meta >#</span><span class=language-bash >SBATCH --job-name=example</span>
<span class=hljs-meta >#</span><span class=language-bash >SBATCH --account=&lt;project&gt;</span>
<span class=hljs-meta >#</span><span class=language-bash >SBATCH --partition=large</span>
<span class=hljs-meta >#</span><span class=language-bash >SBATCH --time=02:00:00</span>
<span class=hljs-meta >#</span><span class=language-bash >SBATCH --nodes=100</span>
<span class=hljs-meta >#</span><span class=language-bash >SBATCH --hint=multithread</span>
<span class=hljs-meta >#</span><span class=language-bash >SBATCH --ntasks-per-node=16</span>
<span class=hljs-meta >#</span><span class=language-bash >SBATCH --cpus-per-task=16</span>
<span class=hljs-meta >
# </span><span class=language-bash >Note that the ntasks-per-node * cpus-per-task = total core counts with hyperthreading</span>
<span class=hljs-meta >
# </span><span class=language-bash >Set the number of threads based on --cpus-per-task</span>
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK

srun myprog &lt;options&gt;</code></pre>
<div class=page-foot >
  <div class=copyright >
    &copy; Hongyang Zhou. Last modified: September 24, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
    </div> 
    </div> 
    </div> <!-- end of class page-wrap-->