<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/vlasiator_manual/libs/highlight/github.min.css"> <link rel=stylesheet  href="/vlasiator_manual/css/jtd.css"> <link rel=icon  href="/vlasiator_manual/assets/favicon.ico"> <title>Internal</title> <div class=page-wrap > <div class=side-bar > <div class=header > <a href="/vlasiator_manual/" class=title > Vlasiator </a> </div> <label for=show-menu  class=show-menu >MENU</label> <input type=checkbox  id=show-menu  role=button > <div class=menu  id=side-menu > <ul class=menu-list > <li class="menu-list-item "><a href="/vlasiator_manual/" class="menu-list-link ">Home</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/" class="menu-list-link ">Installation</a> <ul class="menu-list-child-list "> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#dccrg" class=menu-list-link >DCCRG</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#zoltan" class=menu-list-link >Zoltan</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#boost" class=menu-list-link >Boost</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#eigen" class=menu-list-link >Eigen</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#jemalloc" class=menu-list-link >Jemalloc</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#phiprof" class=menu-list-link >PhiProf</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu1/#papi" class=menu-list-link >Papi</a> </ul> <li class="menu-list-item "><a href="/vlasiator_manual/menu2/" class="menu-list-link ">Run</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu3/" class="menu-list-link ">Postprocessing</a> <li class="menu-list-item active"><a href="/vlasiator_manual/menu4/" class="menu-list-link active">Internal</a> <ul class="menu-list-child-list "> <li class="menu-list-item "><a href="/vlasiator_manual/menu4/#sysboundary" class=menu-list-link >SysBoundary</a> </ul> <li class="menu-list-item "><a href="/vlasiator_manual/menu5/" class="menu-list-link ">Test</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu6/" class="menu-list-link ">Misc</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu7/" class="menu-list-link ">Method</a> <li class="menu-list-item "><a href="/vlasiator_manual/menu8/" class="menu-list-link ">Trouble Shooting</a> </ul> </div> <div class=footer > This is <em>Just the docs</em>, adapted from the <a href="https://github.com/pmarsceill/just-the-docs" target=_blank >Jekyll theme</a>. </div> </div> <div class=main-content-wrap > <div class=main-content > <div class=main-header > <a id=github  href="/vlasiator_manual//github.com/fmihpc/vlasiator">Vlasiator on GitHub</a> </div> <div class=franklin-content ><h1 id=internal_code_structure ><a href="#internal_code_structure" class=header-anchor >Internal Code Structure</a></h1> <div class=franklin-toc ><ol><li><a href="#main">Main</a><li><a href="#definitions">Definitions</a><li><a href="#common">Common</a><li><a href="#parameters">Parameters</a><li><a href="#sysboundary">SysBoundary</a><ol><li><a href="#sysboundarycondition">SysBoundaryCondition</a><li><a href="#setbyuser">SetByUser</a></ol></ol></div> <p>In C&#43;&#43;, the included files should be ordered and grouped. This part can be done with an automatic script. It should be able to:</p> <ul> <li><p>Correct function and file names according to naming standard &#40;<code>.hpp → .h</code>, <code>datareducer → dataReducer</code>&#41;</p> <li><p>Switch orders of #include if required</p> <li><p>Correct comments indentation and argument indentations.</p> </ul> <p>I need to go through the coding standard.</p> <h2 id=main ><a href="#main" class=header-anchor >Main</a></h2> <code>vlasiator.cpp</code> <pre><code class="cpp hljs"><span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&lt;cstdlib&gt;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&lt;iostream&gt;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&lt;cmath&gt;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&lt;vector&gt;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&lt;sstream&gt;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&lt;ctime&gt;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >ifdef</span> _OPENMP</span>
   <span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&lt;omp.h&gt;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >endif</span></span>

<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&lt;fsgrid.hpp&gt;</span></span>

<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;vlasovmover.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;definitions.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;mpiconversion.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;logger.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;parameters.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;readparameters.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;spatial_cell.hpp&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;datareduction/datareducer.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;sysboundary/sysboundary.h&quot;</span></span>

<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;fieldsolver/fs_common.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;projects/project.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;grid.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;iowrite.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;ioread.h&quot;</span></span>

<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;object_wrapper.h&quot;</span></span>
<span class=hljs-meta >#<span class=hljs-keyword >include</span> <span class=hljs-string >&quot;fieldsolver/gridGlue.hpp&quot;</span></span></code></pre> <p>Stages:</p> <ol> <li><p>Initialization</p> </ol> <ul> <li><p>Read parameters</p> <li><p>Open logFile &amp; diagnostic</p> <li><p>Init project</p> <li><p>Init fieldsolver grids</p> <li><p>Init grids</p> <ul> <li><p><code>initializeGrids&#40;&#41;</code> creates the <code>sysBoundaries</code> object;</p> <li><p><code>isSysBoundaryCondDynamic</code> determines if we need to update BCs.</p> </ul> <li><p>Init DROs</p> <ul> <li><p>Initialize data reduction operators.</p> </ul> <li><p>getFieldsFromFsGrid</p> <ul> <li><p>Obtain initial B field after calling <code>propagateFields&#40;&#41;</code> with <code>dt&#61;0</code>?</p> </ul> <li><p>compute-dt</p> <li><p>write-initial-state</p> <li><p>compute-dt</p> <li><p>propagate-velocity-space-dt/2</p> </ul> <ol start=2 > <li><p>Simulation</p> </ol> <ul> <li><p>IO</p> <ul> <li><p>Check whether external STOP, KILL or SAVE has been passed</p> <ul> <li><p><code>checkExternalCommands&#40;&#41;</code></p> </ul> <li><p>Profiling and diagnosing</p> <ul> <li><p>phiprof</p> <li><p><code>writeDiagnostic&#40;&#41;</code></p> </ul> <li><p>Write system</p> <ul> <li><p>not sure if this is the real output?</p> </ul> <li><p>Bailing out from all processes: what does it mean?</p> <ul> <li><p><code>MPI-Allreduce&#40;&#41;</code></p> </ul> <li><p>Write restart if needed</p> <li><p>Check load balancing</p> </ul> <li><p>Calculate the number of solved local cells</p> <li><p>Update dt</p> <ul> <li><p>This step is closely related to the leap frog scheme.</p> </ul> <li><p>Propagate for one step</p> <ul> <li><p>Spatial-space</p> <ul> <li><p><code>calculateSpatialTranslation&#40;&#41;</code>: for some reason everything is commented out in this function?</p> </ul> <li><p>Update system boundaries</p> <ul> <li><p><code>sysBoundaries.applySysBoundaryVlasovConditions&#40;&#41;</code></p> <li><p>This is the first call to the BCs.</p> </ul> <li><p>Compute interp moments</p> <ul> <li><p><code>calculateInterpolatedVelocityMoments&#40;&#41;</code></p> </ul> <li><p>Propagate Fields</p> <ul> <li><p>Copy moments onto the fsgrid.</p> <li><p><code>propagateFields&#40;&#41;</code>: calculate field for the next time step.</p> <li><p><code>getFieldsFromFsGrid&#40;&#41;</code>: copy results back from fsgrid.</p> </ul> <li><p>Update velocity</p> <ul> <li><p><code>calculateAcceleration&#40;&#41;</code>: accelerate all particle populations to the next time step.</p> </ul> <li><p>Update system boundaries</p> <ul> <li><p><code>sysBoundaries.applySysBoundaryVlasovConditions&#40;&#41;</code></p> <li><p>This is the second call to the BCs.</p> </ul> <li><p>Compute interpolated velocity moments</p> <ul> <li><p><code>calculateInterpolatedVelocityMoments&#40;&#41;</code></p> </ul> <li><p>Project specified calls</p> <ul> <li><p><code>project-&gt;hook&#40;&#41;</code></p> </ul> </ul> </ul> <ol start=3 > <li><p>Finalization</p> </ol> <p>Questions:</p> <ul> <li><p><code>object_wrapper.h</code>: it defines a struct named ObjectWrapper which contains the AMR criteria, container for user-defined mesh data, parameters for all particle species, projects, and parameters for velocity meshes.</p> <li><p><code>fieldsolver/gridGlue.hpp</code>: names are not following the same standard&#33;</p> <li><p><code>phiprof.hpp</code></p> </ul> <p>The usage of this profiler is quite similar to Gabor’s library, both of which should be using <code>mpi_wtime</code> on the lower level.</p> <p>During compilation, there is a warning about <code>narrowing conversion of ...</code>. What does it mean and why do we need this?</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> namespace phiprof
<span class=hljs-keyword >using</span> namespace std</code></pre> <p>Since they are already imported, there is no need to add <code>std::</code> in the rest of code.</p> <ul> <li><p><code>recalculateLocalCellsCache&#40;&#41;</code>: why do we need another local block for the 2 lines?</p> <li><p>What is “ad” in the following comments? &quot;and&quot;?</p> </ul> <blockquote> <p>needs to be done here already ad the background field will be set right away,</p> </blockquote> <ul> <li><p>As one can see, there are many FsGrid objects, but they now all share some common values like dx, dy, dz, etc. Why do we need separate values of those?</p> <li><p>The cubic spatial cell requirement is to restrict. Users have to calculate it themselves and even if the cells are not cubic the code will only give a warning message but still run. Maybe we should just add something to the kernel functions.</p> <li><p>The comments for initializing data reduction operators are confusing.</p> <li><p>The main loop with while: Phiprof diagnostic output is fixed to 10 steps. We should have the flexibility to change that.</p> <li><p>The condition <code>P::propagateField</code> comments say that it is only for B field? But I can see all the fields in the argument list of propagteFields?</p> <li><p><code>getFieldsFromFsGrid&#40;&#41;</code>: since the field solver is working on a regular Cartesian grid, this is supposed to copy field results back to dccrg grid for vdf?</p> </ul> <h2 id=definitions ><a href="#definitions" class=header-anchor >Definitions</a></h2> <ul> <li><p>What should go into <code>common.h</code>, <code>definitions.h</code>, and <code>parameters.h</code> respectively?</p> </ul> <code>definitions.h</code> <ul> <li><p><code>namespace vmesh</code>: doesn’t it look the same with/without AMR? </p> </ul> <p>I have no clue why this local block ID has to be defined here, since it probably only lives in a local scope.</p> <h2 id=common ><a href="#common" class=header-anchor >Common</a></h2> <code>common.h</code> <p><code>Namespace sysboundarytype</code>: is SET_MAXWELLIAN for the fixed inflow?</p> <h2 id=parameters ><a href="#parameters" class=header-anchor >Parameters</a></h2> <code>parameters.h</code> <ul> <li><p>Why are there a max and a min CFL number?</p> <li><p>What is the difference between <code>vector&lt;CellID&gt;</code> and <code>vector&lt;CellID&gt;&amp;</code>? Does the second one mean that it is essentially the same vector without copying?</p> </ul> <h2 id=sysboundary ><a href="#sysboundary" class=header-anchor >SysBoundary</a></h2> <p>The code structure here is slightly more complicated than I thought. In the main function, <code>sysBoundary.applySysBoundaryVlasovConditions&#40;&#41;</code> is called for setting the BCs. <code>sysBoundary</code> is a high level wrapper class for initializing, storing, and applying all types of system boundary conditions. The actual classes for BCs are defined in <code>sysboundarycondition.cpp</code>, within the scope of <code>namespace SBC</code>. It contains a base abstract class called <code>SysBoundaryCondition</code>, and 5 derived classes:</p> <ul> <li><p><code>DoNotCompute</code></p> <li><p><code>Ionosphere</code></p> <li><p><code>Outflow</code></p> <li><p><code>SetMaxwellian</code></p> <li><p><code>SetByUser</code></p> </ul> <p>The prefix <code>sys</code> is used to distinguish between physical simulation domain boundary and MPI process boundary. However, in most cases MPI process boundary should be renamed to something else, and the boundary will be interpreted by most people the whole mesh&#39;s boundary.</p> <p>Personally I don&#39;t like the name of <code>SetMaxwellian</code> for two reasons: firstly it is a verb, secondly it is not descriptive enough. We may change it to <code>Inflow</code> and then make <code>Maxwellian</code> one option among the available choices. Also currently <code>SetMaxwellian</code> is a subclass of <code>SetByUser</code>, which I think should not be the case. So I envision the subclasses of <code>sysBoundaryCondition</code> like this:</p> <ul> <li><p><code>Nothing</code></p> <li><p><code>Ionosphere</code></p> <li><p><code>Outflow</code></p> <li><p><code>Inflow</code></p> <li><p><code>Fixed</code></p> <li><p><code>User</code></p> </ul> <p>There are 3 choices in the <code>Outflow</code> type:</p> <ol> <li><p><code>None</code>: do nothing</p> <li><p><code>Copy</code>: copy the values from the last physcial cell</p> <li><p><code>Limit</code>: multiply the values from the last physcial cell by a factor between &#40;0,1&#41;?</p> </ol> <p>There are currently bugs related to the <code>Outflow</code> BC. </p> <p><code>Fixed</code> is equivalent to the previous <code>SetMaxwellian</code>, <code>Inflow</code> corresponds to the time-varying BCs, and <code>User</code> is provided as an interface for extrenal implementations. To do this, I also need to modify the enumerators defined in <code>common.h</code>. In the definition of classes, variables should always come first, followed by methods&#33;</p> <p>The base class has a private variable <code>sysBoundaryCondList</code> to keep track of all the boundary conditions as strings. Can this possess multiple options for the same BC class?</p> <p>In <code>Commons.h</code>, the general information for the grid is defined:</p> <pre><code class="cpp hljs"><span class=hljs-keyword >struct</span> <span class="hljs-title class_">technical</span> {
   <span class=hljs-type >int</span> sysBoundaryFlag;  <span class=hljs-comment >/* System boundary flags */</span>
   <span class=hljs-type >int</span> sysBoundaryLayer; <span class=hljs-comment >/* System boundary layer index */</span>
   Real maxFsDt;         <span class=hljs-comment >/* Maximum timestep allowed in ordinary space by fieldsolver for this cell */</span>
   <span class=hljs-type >int</span> fsGridRank;       <span class=hljs-comment >/* Rank in the fsGrids cartesian coordinator */</span>
   uint SOLVE;           <span class=hljs-comment >/* Bit mask to determine whether a given cell should solve E or B components */</span>
   <span class=hljs-type >int</span> refLevel;         <span class=hljs-comment >/* AMR Refinement Level */</span>
};</code></pre> <div class="admonition note"><p class=admonition-title >Note</p><p><code>Real</code> is a self-defined type, which can be <code>float</code> or <code>double</code> depending on the compilation flag. </p> </div> <ul> <li><p><code>getParameters&#40;&#41;</code>: reads from the configuration file and sets periodic BC. It may be better to make periodicity just one type of BCs.</p> <li><p><code>initSysBoundaries&#40;&#41;</code>: loops through the list of system boundary conditions listed as to be used in the configuration file/command line arguments. For each of these it adds the corresponding instance and updates the member <code>isThisDynamic</code> to determine whether any <code>SysBoundaryCondition</code> is dynamic in time. This can be modified to remove the periodicity checking, and the boundary list initialization from <code>sysBoundaryCondList</code> is unnecessary. All types of boundary conditions should be prescribed in the class.</p> </ul> <p><code>P::xcells_ini</code>: what does this effect?</p> <ul> <li><p><code>checkRefinement&#40;&#41;</code>: for AMR usage presumably?</p> <li><p><code>belongsToLayer&#40;&#41;</code>: checks ghost cell layers?</p> <li><p><code>classifyCells&#40;&#41;</code>: loops through all cells and and assigns the correct <code>sysBoundaryFlag</code> depending for each BCs. This is a quite long one.</p> <li><p><code>applyInitialState&#40;&#41;</code>: loops through all <code>SysBoundaryConditions</code> and calls the corresponding <code>applyInitialState&#40;&#41;</code> function for all existing particle species.</p> <li><p><code>applySysBoundaryVlasovConditions&#40;&#41;</code>: applys the Vlasov system boundary conditions to all system boundary cells. It loops through all <code>SysBoundaryConditions</code> and calls the corresponding <code>vlasovBoundaryCondition&#40;&#41;</code> function for all moments for all particle species. I think this is the place where the dynamic BCs should be called.</p> </ul> <h3 id=sysboundarycondition ><a href="#sysboundarycondition" class=header-anchor >SysBoundaryCondition</a></h3> <ul> <li><p><code>determineFace&#40;&#41;</code>: determine on which faces if any cell at the given coordinates is. I did some syntax optimizations.</p> <li><p><code>addSysBoundary&#40;&#41;</code>: called from <code>initSysBoundaries&#40;&#41;</code> in the <code>sysBoundary</code> class.</p> <li><p><code>getSysBoundary&#40;&#41;</code>: get the pointer to a specific BC.</p> <li><p><code>initSysBoundary&#40;&#41;</code>: initialize a specific BC.</p> <li><p><code>vlasovBoundaryCopyFromTheClosestNbr&#40;&#41;</code>: copy the distribution and moments from &#40;one of&#41; the closest cell that is not a boundary. Is this used for the <code>Outflow</code> type BC? The last argument, <code>calculate_V_moments</code>, is renamed to <code>doCalcMomentsV</code> to avoid being too similar to a function.</p> </ul> <p>There are two functions for setting the derivatives to zeroes.</p> <h3 id=setbyuser ><a href="#setbyuser" class=header-anchor >SetByUser</a></h3> <div class=page-foot > <div class=copyright > &copy; Hongyang Zhou. Last modified: October 19, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div> </div> <!-- end of class page-wrap-->